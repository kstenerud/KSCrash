name: Benchmarks

on:
  pull_request:
    paths:
      - "Sources/**"
      - "Tests/KSCrashBenchmarks/**"
      - "Tests/KSCrashBenchmarksObjC/**"
      - "Tests/KSCrashBenchmarksCold/**"
      - "Benchmarks/**"
      - "Package.swift"
      - ".github/workflows/benchmarks.yml"

  push:
    branches:
      - master

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    runs-on: macos-latest
    # Skip for fork PRs (no write permissions to comment on PR)
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          path: pr-branch

      - name: Checkout Base Branch
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v6
        with:
          ref: ${{ github.base_ref }}
          path: base-branch

      - name: Use Latest Stable Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Ensure the Platform is Downloaded
        run: |
          xcodebuild -runFirstLaunch
          xcrun simctl list
          xcodebuild -downloadPlatform iOS
          xcodebuild -runFirstLaunch

      - name: Setup Mise
        uses: jdx/mise-action@v3

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Run PR Benchmarks
        working-directory: pr-branch/Benchmarks
        run: |
          mise exec -- tuist generate --no-open
          rm -rf ../../pr_benchmarks.xcresult
          set -o pipefail
          xcodebuild -workspace KSCrashBenchmarks.xcworkspace \
            -scheme Benchmarks \
            -destination 'platform=iOS Simulator,name=iPhone 17' \
            -resultBundlePath ../../pr_benchmarks.xcresult \
            test 2>&1 | xcbeautify

      - name: Run Base Benchmarks
        if: github.event_name == 'pull_request'
        run: |
          if [ -d "base-branch/Benchmarks" ] && [ -f "base-branch/Benchmarks/Project.swift" ]; then
            cd base-branch/Benchmarks
            mise exec -- tuist generate --no-open
            rm -rf ../../base_benchmarks.xcresult
            set -o pipefail
            xcodebuild -workspace KSCrashBenchmarks.xcworkspace \
              -scheme Benchmarks \
              -destination 'platform=iOS Simulator,name=iPhone 17' \
              -resultBundlePath ../../base_benchmarks.xcresult \
              test 2>&1 | xcbeautify
          fi

      - name: Parse and Format Results
        run: |
          python3 pr-branch/.github/scripts/parse_benchmarks.py \
            --pr-results pr_benchmarks.xcresult \
            --base-results base_benchmarks.xcresult \
            --config pr-branch/.github/data/benchmark-tests.json

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: benchmark_results.md
          comment-tag: benchmark-results
