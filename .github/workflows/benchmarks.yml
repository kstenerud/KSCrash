name: Benchmarks

on:
  pull_request:
    paths:
      - "Sources/**"
      - "Tests/KSCrashBenchmarks/**"
      - "Tests/KSCrashBenchmarksObjC/**"
      - "Tests/KSCrashBenchmarksCold/**"
      - "Benchmarks/**"
      - "Package.swift"
      - ".github/workflows/benchmarks.yml"
      - ".github/workflows/browserstack.yml"

  push:
    branches:
      - master

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Run benchmarks on PR code
  browserstack-pr:
    # Skip for fork PRs (no access to secrets)
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    uses: ./.github/workflows/browserstack.yml
    with:
      ref: ${{ github.event.pull_request.head.sha || github.sha }}
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  # Run benchmarks on main branch for comparison (only on PRs)
  browserstack-main:
    needs: [browserstack-pr]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/browserstack.yml
    with:
      ref: ${{ github.base_ref }}
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  # Compare results and post to PR
  compare-results:
    needs: [browserstack-pr, browserstack-main]
    if: github.event_name == 'pull_request'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download PR Results
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.browserstack-pr.outputs.results_artifact }}
          path: pr-results

      - name: Download Main Results
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.browserstack-main.outputs.results_artifact }}
          path: main-results

      - name: Extract Result Bundles
        run: |
          # Extract PR results
          if [ -f pr-results/result_bundle.xcresult.zip ]; then
            unzip -q pr-results/result_bundle.xcresult.zip -d pr-results
            PR_XCRESULT=$(find pr-results -name "*.xcresult" -type d | head -1)
            echo "PR xcresult: $PR_XCRESULT"
            if [ -n "$PR_XCRESULT" ]; then
              mv "$PR_XCRESULT" pr_benchmarks.xcresult
            fi
          fi

          # Extract main results
          if [ -f main-results/result_bundle.xcresult.zip ]; then
            unzip -q main-results/result_bundle.xcresult.zip -d main-results
            MAIN_XCRESULT=$(find main-results -name "*.xcresult" -type d | head -1)
            echo "Main xcresult: $MAIN_XCRESULT"
            if [ -n "$MAIN_XCRESULT" ]; then
              mv "$MAIN_XCRESULT" base_benchmarks.xcresult
            fi
          fi

          ls -la *.xcresult || echo "No xcresult bundles found"

      - name: Parse and Format Results
        run: |
          python3 .github/scripts/parse_benchmarks.py \
            --pr-results pr_benchmarks.xcresult \
            --base-results base_benchmarks.xcresult \
            --config .github/data/benchmark-tests.json

      - name: Comment PR with Results
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: benchmark_results.md
          comment_tag: benchmark-results

  # Post results summary for push events (no comparison)
  post-results:
    needs: [browserstack-pr]
    if: github.event_name == 'push'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Results
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.browserstack-pr.outputs.results_artifact }}
          path: results

      - name: Extract and Parse Results
        run: |
          if [ -f results/result_bundle.xcresult.zip ]; then
            unzip -q results/result_bundle.xcresult.zip -d results
            XCRESULT=$(find results -name "*.xcresult" -type d | head -1)
            if [ -n "$XCRESULT" ]; then
              mv "$XCRESULT" pr_benchmarks.xcresult
              python3 .github/scripts/parse_benchmarks.py \
                --pr-results pr_benchmarks.xcresult \
                --config .github/data/benchmark-tests.json
              cat benchmark_results.md
            fi
          fi

      - name: Print BrowserStack Link
        run: |
          echo "## BrowserStack Benchmark Results"
          echo ""
          echo "Build ID: ${{ needs.browserstack-pr.outputs.build_id }}"
          echo "Status: ${{ needs.browserstack-pr.outputs.build_status }}"
          echo ""
          echo "View detailed results at:"
          echo "https://app-automate.browserstack.com/dashboard/v2/builds/${{ needs.browserstack-pr.outputs.build_id }}"
