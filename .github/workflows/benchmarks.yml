name: Benchmarks

on:
  pull_request:
    paths:
      - "Sources/**"
      - "Tests/KSCrashBenchmarks/**"
      - "Tests/KSCrashBenchmarksObjC/**"
      - "Tests/KSCrashBenchmarksCold/**"
      - "Benchmarks/**"
      - "Package.swift"
      - ".github/workflows/benchmarks.yml"
      - ".github/workflows/browserstack.yml"
      - ".github/scripts/perfcomp.py"

  push:
    branches:
      - master

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Run benchmarks on PR code
  browserstack-pr:
    # Skip for fork PRs (no access to secrets)
    if: |
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    uses: ./.github/workflows/browserstack.yml
    with:
      ref: ${{ github.event.pull_request.head.sha || github.sha }}
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  # Run benchmarks on main branch for comparison (only on PRs)
  browserstack-main:
    needs: [browserstack-pr]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/browserstack.yml
    with:
      ref: ${{ github.base_ref }}
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  # Compare results and post to PR
  compare-results:
    needs: [browserstack-pr, browserstack-main]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install scipy pygithub

      - name: Compare Performance
        env:
          PERF_PR: ${{ needs.browserstack-pr.outputs.results }}
          PERF_MAIN: ${{ needs.browserstack-main.outputs.results }}
          THRESHOLD_PCT: "5"
          ALPHA: "0.05"
          TITLE: "KSCrash Performance Benchmarks"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: python .github/scripts/perfcomp.py

  # Post results summary for push events (no comparison)
  post-results:
    needs: [browserstack-pr]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Print Results Summary
        run: |
          echo "## BrowserStack Benchmark Results"
          echo ""
          echo "Build ID: ${{ needs.browserstack-pr.outputs.build_id }}"
          echo "Status: ${{ needs.browserstack-pr.outputs.build_status }}"
          echo ""
          echo "View detailed results at:"
          echo "https://app-automate.browserstack.com/dashboard/v2/builds/${{ needs.browserstack-pr.outputs.build_id }}"
