name: Benchmarks

on:
  pull_request:
    paths:
      - "Sources/**"
      - "Tests/KSCrashBenchmarks/**"
      - "Tests/KSCrashBenchmarksObjC/**"
      - "Tests/KSCrashBenchmarksCold/**"
      - "Benchmarks/**"
      - "Package.swift"
      - ".github/workflows/benchmarks.yml"
      - ".github/workflows/browserstack.yml"

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Check if base branch has BenchmarksBrowserStack scheme
  check-base-branch:
    runs-on: ubuntu-latest
    outputs:
      has_browserstack_scheme: ${{ steps.check.outputs.has_scheme }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.base_ref }}

      - name: Check for BenchmarksBrowserStack scheme
        id: check
        run: |
          if grep -q "BenchmarksBrowserStack" Benchmarks/Project.swift 2>/dev/null; then
            echo "has_scheme=true" >> $GITHUB_OUTPUT
            echo "Base branch has BenchmarksBrowserStack scheme"
          else
            echo "has_scheme=false" >> $GITHUB_OUTPUT
            echo "Base branch does not have BenchmarksBrowserStack scheme"
          fi

  # Run benchmarks on PR code
  browserstack-pr:
    # Skip when secrets are unavailable (fork PRs, Dependabot, etc.)
    if: secrets.BROWSERSTACK_USERNAME != ''
    uses: ./.github/workflows/browserstack.yml
    with:
      ref: ${{ github.event.pull_request.head.sha || github.sha }}
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  # Run benchmarks on main branch for comparison (only if scheme exists)
  browserstack-main:
    needs: [browserstack-pr, check-base-branch]
    if: needs.check-base-branch.outputs.has_browserstack_scheme == 'true'
    uses: ./.github/workflows/browserstack.yml
    with:
      ref: ${{ github.base_ref }}
    secrets:
      BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
      BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

  # Parse and post results
  post-results:
    needs: [browserstack-pr, browserstack-main, check-base-branch]
    if: always() && needs.browserstack-pr.result == 'success'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download PR Results
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.browserstack-pr.outputs.results_artifact }}
          path: pr-results

      - name: Download Main Results
        if: needs.check-base-branch.outputs.has_browserstack_scheme == 'true' && needs.browserstack-main.result == 'success'
        uses: actions/download-artifact@v7
        with:
          name: ${{ needs.browserstack-main.outputs.results_artifact }}
          path: main-results

      - name: Extract Result Bundles
        run: |
          # Extract and merge PR shard results into a single xcresult
          extract_and_merge() {
            local src_dir="$1"
            local output="$2"

            local xcresults=()
            for zip in "$src_dir"/*.zip; do
              [ -f "$zip" ] || continue
              local name=$(basename "$zip" .zip)
              unzip -q "$zip" -d "$src_dir/${name}_extracted"
              local found=$(find "$src_dir/${name}_extracted" -name "*.xcresult" -type d | head -1)
              if [ -n "$found" ]; then
                xcresults+=("$found")
              fi
            done

            if [ ${#xcresults[@]} -eq 0 ]; then
              echo "No xcresult bundles found in $src_dir"
              return 1
            elif [ ${#xcresults[@]} -eq 1 ]; then
              mv "${xcresults[0]}" "$output"
            else
              echo "Merging ${#xcresults[@]} xcresult bundles..."
              xcrun xcresulttool merge "${xcresults[@]}" --output-path "$output"
            fi
            echo "Output: $output"
          }

          # Extract PR results
          if ls pr-results/*.zip 1>/dev/null 2>&1; then
            extract_and_merge pr-results pr_benchmarks.xcresult
          else
            echo "No PR result bundles found"
          fi

          # Extract main results (if available)
          if ls main-results/*.zip 1>/dev/null 2>&1; then
            extract_and_merge main-results base_benchmarks.xcresult
          else
            echo "No main results available (BenchmarksBrowserStack may not exist on base branch yet)"
          fi

      - name: Parse and Format Results
        run: |
          # Only pass base-results if the file exists
          if [ -d "base_benchmarks.xcresult" ]; then
            python3 .github/scripts/parse_benchmarks.py \
              --pr-results pr_benchmarks.xcresult \
              --base-results base_benchmarks.xcresult \
              --config .github/data/benchmark-tests.json
          else
            python3 .github/scripts/parse_benchmarks.py \
              --pr-results pr_benchmarks.xcresult \
              --config .github/data/benchmark-tests.json
          fi

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: benchmark_results.md
          comment-tag: benchmark-results
