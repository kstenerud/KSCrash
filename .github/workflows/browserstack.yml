name: BrowserStack Benchmarks

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string
        default: ''
    secrets:
      BROWSERSTACK_USERNAME:
        required: true
      BROWSERSTACK_ACCESS_KEY:
        required: true
    outputs:
      build_id:
        description: 'BrowserStack build ID'
        value: ${{ jobs.test.outputs.build_id }}
      build_status:
        description: 'Build status (passed/failed/error)'
        value: ${{ jobs.test.outputs.build_status }}
      results_artifact:
        description: 'Name of the results artifact'
        value: ${{ jobs.test.outputs.results_artifact }}

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30
    outputs:
      app_url: ${{ steps.upload_app.outputs.app_url }}
      test_suite_url: ${{ steps.upload_test_suite.outputs.test_suite_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Use Latest Stable Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Mise
        uses: jdx/mise-action@v2

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Generate Project
        working-directory: Benchmarks
        run: mise exec -- tuist generate --no-open

      - name: Archive Benchmarks App
        working-directory: Benchmarks
        run: |
          xcodebuild archive \
            -workspace KSCrashBenchmarks.xcworkspace \
            -scheme BenchmarksBrowserStack \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/BenchmarkApp.xcarchive \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcbeautify

      - name: Export IPA
        working-directory: Benchmarks
        run: |
          # Extract the .app from the archive and create IPA manually
          mkdir -p build/Payload
          cp -r build/BenchmarkApp.xcarchive/Products/Applications/BenchmarkApp.app build/Payload/

          # Create IPA (it's just a zip file with Payload folder)
          cd build
          zip -r ../BenchmarkApp.ipa Payload
          cd ..

          rm -rf build/Payload
          ls -lh BenchmarkApp.ipa

      - name: Build UI Test Runner
        working-directory: Benchmarks
        run: |
          xcodebuild build-for-testing \
            -workspace KSCrashBenchmarks.xcworkspace \
            -scheme BenchmarksBrowserStack \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            -only-testing:BenchmarkUITests \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            | xcbeautify

      - name: Create Test Suite Zip
        working-directory: Benchmarks
        run: |
          # Find the test runner app
          TEST_RUNNER_PATH=$(find build/DerivedData/Build/Products/Release-iphoneos -name "BenchmarkUITests-Runner.app" -type d | head -1)
          echo "Test runner path: $TEST_RUNNER_PATH"

          # Create test suite zip (just the Runner.app, not in Payload format)
          cd $(dirname "$TEST_RUNNER_PATH")
          zip -r "$GITHUB_WORKSPACE/BenchmarkUITests.zip" "BenchmarkUITests-Runner.app"
          cd "$GITHUB_WORKSPACE"

          ls -lh BenchmarkUITests.zip

      - name: Upload App to BrowserStack
        id: upload_app
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          APP_UPLOAD_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/xcuitest/v2/app" \
            -F "file=@Benchmarks/BenchmarkApp.ipa")

          echo "App upload response: $APP_UPLOAD_RESPONSE"
          APP_URL=$(echo "$APP_UPLOAD_RESPONSE" | jq -r '.app_url')

          if [ -z "$APP_URL" ] || [ "$APP_URL" = "null" ]; then
            echo "Error uploading app"
            exit 1
          fi

          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "App uploaded successfully: $APP_URL"

      - name: Upload Test Suite to BrowserStack
        id: upload_test_suite
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          TEST_UPLOAD_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/xcuitest/v2/test-suite" \
            -F "file=@BenchmarkUITests.zip")

          echo "Test suite upload response: $TEST_UPLOAD_RESPONSE"
          TEST_SUITE_URL=$(echo "$TEST_UPLOAD_RESPONSE" | jq -r '.test_suite_url')

          if [ -z "$TEST_SUITE_URL" ] || [ "$TEST_SUITE_URL" = "null" ]; then
            echo "Error uploading test suite"
            exit 1
          fi

          echo "test_suite_url=$TEST_SUITE_URL" >> $GITHUB_OUTPUT
          echo "Test suite uploaded successfully: $TEST_SUITE_URL"

  test:
    runs-on: ubuntu-latest
    needs: build
    if: success()
    timeout-minutes: 60
    outputs:
      build_id: ${{ steps.execute_tests.outputs.build_id }}
      build_status: ${{ steps.wait_tests.outputs.build_status }}
      session_id: ${{ steps.wait_tests.outputs.session_id }}
      results_artifact: ${{ steps.artifact_name.outputs.name }}

    steps:
      - name: Set Artifact Name
        id: artifact_name
        run: |
          echo "name=browserstack-results-${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT

      - name: Execute Tests on BrowserStack
        id: execute_tests
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          APP_URL: ${{ needs.build.outputs.app_url }}
          TEST_SUITE_URL: ${{ needs.build.outputs.test_suite_url }}
        run: |
          BUILD_RESPONSE=$(curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
            -X POST "https://api-cloud.browserstack.com/app-automate/xcuitest/v2/build" \
            -H "Content-Type: application/json" \
            -d "{
              \"devices\": [\"iPhone 16 Pro-18\"],
              \"app\": \"$APP_URL\",
              \"testSuite\": \"$TEST_SUITE_URL\",
              \"project\": \"KSCrash Benchmarks\",
              \"buildName\": \"Benchmarks - ${{ github.sha }}\",
              \"networkLogs\": false,
              \"deviceLogs\": true,
              \"video\": false,
              \"enableResultBundle\": true
            }")

          echo "Build execution response: $BUILD_RESPONSE"
          BUILD_ID=$(echo "$BUILD_RESPONSE" | jq -r '.build_id')

          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
            echo "Error starting tests"
            exit 1
          fi

          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Tests started with build ID: $BUILD_ID"
          echo "View results at: https://app-automate.browserstack.com/dashboard/v2/builds/$BUILD_ID"

      - name: Wait for Tests to Complete
        id: wait_tests
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BUILD_ID: ${{ steps.execute_tests.outputs.build_id }}
        run: |
          echo "Waiting for build $BUILD_ID to complete..."

          MAX_WAIT_TIME=3600
          POLL_INTERVAL=30
          ELAPSED_TIME=0

          while [ $ELAPSED_TIME -lt $MAX_WAIT_TIME ]; do
            BUILD_STATUS_RESPONSE=$(curl -s -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
              -X GET "https://api-cloud.browserstack.com/app-automate/xcuitest/v2/builds/$BUILD_ID")

            STATUS=$(echo "$BUILD_STATUS_RESPONSE" | jq -r '.status')
            echo "Current status: $STATUS (elapsed: ${ELAPSED_TIME}s)"

            if [ "$STATUS" = "passed" ] || [ "$STATUS" = "done" ] || [ "$STATUS" = "failed" ] || [ "$STATUS" = "error" ]; then
              echo "Build finished with status: $STATUS"

              SESSION_ID=$(echo "$BUILD_STATUS_RESPONSE" | jq -r '.devices[0].sessions[0].id // empty')
              echo "session_id=$SESSION_ID" >> $GITHUB_OUTPUT
              echo "build_status=$STATUS" >> $GITHUB_OUTPUT
              break
            fi

            sleep $POLL_INTERVAL
            ELAPSED_TIME=$((ELAPSED_TIME + POLL_INTERVAL))
          done

          if [ $ELAPSED_TIME -ge $MAX_WAIT_TIME ]; then
            echo "Timeout waiting for build to complete"
            exit 1
          fi

      - name: Download Result Bundle
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BUILD_ID: ${{ steps.execute_tests.outputs.build_id }}
          SESSION_ID: ${{ steps.wait_tests.outputs.session_id }}
        run: |
          if [ -z "$SESSION_ID" ] || [ "$SESSION_ID" = "null" ]; then
            echo "Warning: No session ID available"
            exit 0
          fi

          echo "Downloading result bundle for build $BUILD_ID, session $SESSION_ID..."

          curl -u "$BROWSERSTACK_USERNAME:$BROWSERSTACK_ACCESS_KEY" \
            -X GET "https://api-cloud.browserstack.com/app-automate/xcuitest/v2/builds/$BUILD_ID/sessions/$SESSION_ID/resultbundle" \
            -o result_bundle.xcresult.zip

          if [ -f result_bundle.xcresult.zip ]; then
            echo "Result bundle downloaded successfully"
            ls -lh result_bundle.xcresult.zip
          else
            echo "Warning: Result bundle file not created"
          fi

      - name: Upload Result Bundle as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.name }}
          path: result_bundle.xcresult.zip
          if-no-files-found: warn
          retention-days: 7
